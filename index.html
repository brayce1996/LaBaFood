<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>La Ba Food</title>
        <style>
            * { padding: 0; margin: 0; }
            canvas { background: #eee; display: block; margin: 0 auto; }
        </style>
    </head>
    <body>
        <div style="display: none;">
            <img id="laba_img_1" width="210" height="240" src="images/slot_machine/laba1.png" >
            <img id="laba_img_2" width="210" height="240" src="images/slot_machine/laba2.png" >
            <img id="laba_img_3" width="210" height="240" src="images/slot_machine/laba3.png" >

            <img id="jp_flag_img" width="33" height="20" src="images/country_flag/jp_flag.png" >
            <img id="tw_flag_img" width="33" height="20" src="images/country_flag/tw_flag.png" >
            <img id="us_flag_img" width="33" height="20" src="images/country_flag/us_flag.png" >
            <img id="it_flag_img" width="33" height="20" src="images/country_flag/it_flag.png" >

            <img id="bread_img" width="33" height="20" src="images/main_ingredient/bread_slice.png" >
            <img id="fried_img" width="33" height="20" src="images/main_ingredient/fried_chicken_leg.png" >
            <img id="noodles_img" width="33" height="20" src="images/main_ingredient/noodles.png" >
            <img id="rice_img" width="33" height="20" src="images/main_ingredient/rice.png" >
            <img id="soup_img" width="33" height="20" src="images/main_ingredient/soup.png" >

            <img id="cheese_img" width="33" height="20" src="images/support_ingredient/cheese.png" >
            <img id="chicken_img" width="33" height="20" src="images/support_ingredient/chicken.png" >
            <img id="cow_img" width="33" height="20" src="images/support_ingredient/cow.png" >
            <img id="goat_img" width="33" height="20" src="images/support_ingredient/goat.png" >
            <img id="fish_img" width="33" height="20" src="images/support_ingredient/fish.png" >
            <img id="fried_img" width="33" height="20" src="images/support_ingredient/fried_chicken_leg.png" >
            <img id="pig_img" width="33" height="20" src="images/support_ingredient/pig.png" >

        </div>
        <canvas id="myCanvas" width="480" height="320"></canvas>

        <script>
            var canvas = document.getElementById("myCanvas");
            var ctx = canvas.getContext("2d");

            // images
            var laba_img_1  = document.getElementById("laba_img_1");
            var laba_img_2  = document.getElementById("laba_img_2");
            var laba_img_3  = document.getElementById("laba_img_3");

            var jp_flag_img = document.getElementById("jp_flag_img");
            var tw_flag_img = document.getElementById("tw_flag_img");
            var us_flag_img = document.getElementById("us_flag_img");
            var it_flag_img = document.getElementById("it_flag_img");

            var bread_img   = document.getElementById("bread_img");
            var fried_img   = document.getElementById("fried_img");
            var noodles_img = document.getElementById("noodles_img");
            var rice_img    = document.getElementById("rice_img");
            var soup_img    = document.getElementById("soup_img");

            var cheese_img  = document.getElementById("cheese_img");
            var chicken_img = document.getElementById("chicken_img");
            var cow_img     = document.getElementById("cow_img");
            var goat_img    = document.getElementById("goat_img");
            var fish_img    = document.getElementById("fish_img");
            var fried_img   = document.getElementById("fried_img");
            var pig_img     = document.getElementById("pig_img");

            // tick variables
            var tick_period = 4;
            var tick = 0;
            var laba_img = [laba_img_1, laba_img_2, laba_img_3]
            var img_order = [0,1,2,1]
            var is_push_btn = false;

            var bar_rand = [0, 0, 0]

            window.onload = function() {
                ctx.drawImage(laba_img_1, 10, 10)
            }

            canvas.addEventListener('click', function(event) {
                var x = event.pageX - canvas.offsetLeft,
                    y = event.pageY - canvas.offsetTop;

                if (x>=210 && x<=245 && y >=125 && y<=200){
                    is_push_btn = true;
                    for (i=0;i<bar_rand.length;i++){
                        bar_rand[i] = getRandom(300) + 300;
                    }
                }

                //alert('X: '.concat(x.toString()).concat(' Y: ').concat(y.toString()));
            }, false);


            var bar = new Object()
            bar.bk_w = 29;
            bar.bk_h = 18;
            bar.w = 33;
            bar.h = 60;
            bar.x = 80;
            bar.y = 148;
            bar.spin_speed = 5;
            bar.distance = 2 + bar.bk_h;  // the distance between blocks
            bar.blocks = [jp_flag_img, tw_flag_img, us_flag_img, it_flag_img, jp_flag_img, tw_flag_img, jp_flag_img]


            var bar2 = [
                {
                    bar_rand: 0,
                    spin_speed: 5,
                    shift: 0,
                    blocks: [jp_flag_img, tw_flag_img, us_flag_img, it_flag_img, jp_flag_img, tw_flag_img, jp_flag_img],
                    x: 80,
                    y: 148
                },
                {
                    bar_rand: 0,
                    spin_speed: 5,
                    shift: 0,
                    blocks: [bread_img, fried_img, noodles_img, rice_img, soup_img, bread_img, noodles_img],
                    x: 80,
                    y: 148
                },
                {
                    bar_rand: 0,
                    spin_speed: 5,
                    shift: 0,
                    blocks: [cheese_img, chicken_img, cow_img, goat_img, fish_img, fried_img, pig_img],
                    x: 80,
                    y: 148
                }
            ]

            laba_counter = 0;   // for handle-toggling animation of the laba
            shift = 0;
            rolling_tick = 8;
            function draw() {
                // drawing code
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                spin()
                
                //draw blocks
                for(i=0; i < bar.blocks.length; i++){
                    y = (bar.y + bar.distance*(i-2) + shift - (bar.y - bar.distance*2))% (bar.y + bar.h + bar.distance - (bar.y - bar.distance*2)) + (bar.y - bar.distance*2);

                    if (y < bar.y+bar.h && y+bar.bk_h > bar.y){
                        ctx.drawImage(bar.blocks[i], bar.x, y, bar.bk_w, bar.bk_h);
                    }
                }

                
                // draw laba (slot machine
                if(!is_push_btn){
                    ctx.drawImage(laba_img_1, 10, 10);
                }else{
                    ctx.drawImage(laba_img[img_order[laba_counter]], 10, 10);
                    
                    if(tick% (80/tick_period) == 0){   // update per 80 ticks
                        laba_counter ++;
                    }
                    if (laba_counter >= 4){
                        laba_counter = 0;
                        is_push_btn = false;
                    }
                }
                
                tick = (tick+1) % 100000;
            }
            setInterval(draw, tick_period);
            
            function spin(){
                for (i=0 ; i<bar_rand.length ; i++){
                    if (bar_rand[i]>=0 && tick% (rolling_tick/tick_period)==0){

                        shift += bar.spin_speed;
                        bar_rand[i]--;
                        if (bar_rand[i] == -1){   // reset for next spin
                            bar.spin_speed = 5;
                            rolling_tick = 8;
                        }else if (bar_rand[i] < 50){
                            bar.spin_speed = 1;
                        }else if (bar_rand[i] < 80){
                            bar.spin_speed = 2;
                            rolling_tick = 12;
                        }else if (bar_rand[i] < 130){
                            bar.spin_speed = 3;
                        }else if (bar_rand[i] < 200){
                            bar.spin_speed = 4;
                        }
                    }
                }
                
            }

            function getRandom(x){
                return Math.floor(Math.random()*x);
            };
        </script>

    </body>
</html>
